<script setup lang="ts">
import type { RequestParams } from 'nocodb-sdk'
import { ExportTypes } from 'nocodb-sdk'
import NProgress from 'nprogress'
import {
  ActiveViewInj,
  FieldsInj,
  IsPublicInj,
  MetaInj,
  extractSdkResponseErrorMsg,
  inject,
  message,
  ref,
  useI18n,
  useNuxtApp,
  useProject,
  useSmartsheetStoreOrThrow,
} from '#imports'

const { t } = useI18n()

const isPublicView = inject(IsPublicInj, ref(false))

const fields = inject(FieldsInj, ref([]))

const { project } = useProject()

const { $api } = useNuxtApp()

const meta = inject(MetaInj, ref())

const selectedView = inject(ActiveViewInj)

const { sorts, nestedFilters } = useSmartsheetStoreOrThrow()

const exportFile = async (exportType: ExportTypes) => {
  let c = 1
  const responseType = exportType === ExportTypes.EXCEL ? 'text' : 'blob'

  const XLSX = await import('xlsx')
  const FileSaver = await import('file-saver')

  try {
    let res
    message.info('Exporting table data, please wait...')
    NProgress.start()
    if (isPublicView.value) {
      const { exportFile: sharedViewExportFile } = useSharedView()
      res = await sharedViewExportFile(fields.value, exportType, responseType, {
        sortsArr: sorts.value,
        filtersArr: nestedFilters.value,
      })
    } else {
      res = await $api.dbViewRow.export(
        'noco',
        project.value?.title as string,
        meta.value?.title as string,
        selectedView?.value.title as string,
        exportType,
        {
          responseType,
          query: {
            fields: fields.value.map((field) => field.title),
            sortArrJson: JSON.stringify(sorts.value),
            filterArrJson: JSON.stringify(nestedFilters.value),
          },
        } as RequestParams,
      )
    }

    const { data } = res

    if (exportType === ExportTypes.EXCEL) {
      const workbook = XLSX.read(data, { type: 'string' })

      XLSX.writeFile(workbook, `${meta.value?.title}_exported_${c++}.xlsx`)
    } else if (exportType === ExportTypes.CSV) {
      const blob = new Blob([data], { type: 'text/plain;charset=utf-8' })

      FileSaver.saveAs(blob, `${meta.value?.title}_exported_${c++}.csv`)
    }

    message.success(t('msg.success.tableDataExported'))
  } catch (e: any) {
    message.error(await extractSdkResponseErrorMsg(e))
  } finally {
    NProgress.done()
  }
}
</script>

<template>
  <a-menu-item>
    <div v-e="['a:actions:download-csv']" class="nc-project-menu-item" @click="exportFile(ExportTypes.CSV)">
      <MdiDownloadOutline class="text-gray-500" />
      <!-- Download as CSV -->
      {{ $t('activity.downloadCSV') }}
    </div>
  </a-menu-item>

  <a-menu-item>
    <div v-e="['a:actions:download-excel']" class="nc-project-menu-item" @click="exportFile(ExportTypes.EXCEL)">
      <MdiDownloadOutline class="text-gray-500" />
      <!-- Download as XLSX -->
      {{ $t('activity.downloadExcel') }}
    </div>
  </a-menu-item>
</template>
